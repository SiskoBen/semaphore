---
- name: Monitor all core temperatures via sensors JSON and alert Discord
  hosts: GMKTec
  become: false
  vars:
    discord_webhook: "{{ discord_webhook}}"
    sensor_group: "coretemp-isa-0000"
    threshold: 40

  tasks:
    - name: Get JSON output from sensors
      command: sensors -j
      register: sensors_raw
      changed_when: false

    - name: Parse JSON output
      set_fact:
        sensors_json: "{{ sensors_raw.stdout | from_json }}"

    - name: Build full temperature report
      set_fact:
        temp_report: >-
          {% set lines = [] %}
          {% for chip_name, chip_data in sensors_json.items() %}
            {% for sensor_label, values in chip_data.items() %}
              {% if sensor_label != "Adapter" %}
                {% if values is mapping %}
                  {% for field, value in values.items() %}
                    {% if field is match("^temp[0-9]+_input$") %}
                      {% set line = chip_name ~ " â†’ " ~ sensor_label ~ ": " ~ value ~ "Â°C" %}
                      {% set lines = lines + [line] %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {% if sensor_label is match("^temp[0-9]+_input$") %}
                    {% set line = chip_name ~ ": " ~ values ~ "Â°C" %}
                    {% set lines = lines + [line] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {{ lines | join('\n') }}

    - name: Check if any sensor is above threshold
      set_fact:
        hot_sensor_found: >-
          {% set hot = false %}
          {% for chip_data in sensors_json.values() %}
            {% for values in chip_data.values() %}
              {% if values is mapping %}
                {% for val in values.values() %}
                  {% if val is number and val > threshold %}
                    {% set hot = true %}
                  {% endif %}
                {% endfor %}
              {% elif values is number and values > threshold %}
                {% set hot = true %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {{ hot }}

    - name: Send Discord alert with full temperature report
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body: >-
          {
            "content": "ğŸŒ¡ï¸ {{ inventory_hostname }}: Temperature Alert\nThreshold: {{ threshold }}Â°C\n\n```{{ temp_report }}```"
          }
        headers:
          Content-Type: application/json
        status_code: 204
      when: hot_sensor_found
