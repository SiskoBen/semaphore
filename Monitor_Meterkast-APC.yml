---
- name: Monitor UPS status using upsd/upsc
  hosts: GMKTec2
  become: true
  tasks:

    - name: Ensure upsd is installed
      package:
        name: nut
        state: present

    - name: Check if upsd service is running
      service:
        name: nut-server
        state: started
        enabled: true

    - name: Run upsc to get UPS status
      command: upsc meterkast-apc@localhost
      register: upsc_output
      failed_when: upsc_output.rc != 0

    - name: Display UPS status
      debug:
        msg: "{{ upsc_output.stdout_lines }}"
        
    - name: Extract all UPS status flags
      set_fact:
        ups_status_flags: "{{ upsc_output.stdout | regex_findall('ups.status:\\s*(.*)') | first | split(' ') }}"

    - name: Extract full UPS status flags
      set_fact:
        ups_status_full: "{{ ups_status_flags | join(', ') }}"

    - name: Alert if UPS is in alarm state
      when: "'ALARM' in upsc_output.stdout"
      debug:
        msg: "‚ö†Ô∏è UPS is in alarm state! UPS status flags: {{ ups_status_full }}"
        msg: "‚ö†Ô∏è UPS is in alarm state! UPS status flags: {{ ups_status_flags | join(', ') }}"

    - name: Send Discord alert if ALARM is present
      uri:
        url: "{{ discord_webhook}}"
        method: POST
        body_format: json
        body: '{"content": "üö® UPS ALERT: Status contains ALARM! UPS status flags: {{ ups_status_full }}"}'
        headers:
          Content-Type: application/json
        status_code: 204
        when: 'ALARM' in upsc_output.stdout
      
    - name: Alert if UPS is on battery
      when: "'OB' in upsc_output.stdout"
      debug:
        msg: "‚ö†Ô∏è UPS is running on battery!"

    - name: Alert if UPS is low battery
      when: "'LB' in upsc_output.stdout"
      debug:
        msg: "üîã UPS battery is low!"
