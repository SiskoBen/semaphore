---
- name: Monitor all core temperatures via sensors JSON and alert Discord
  hosts: Hardware
  become: false
  vars:
    discord_webhook: "{{ discord_webhook}}"
    sensor_group: "coretemp-isa-0000"
    threshold: 70

  tasks:
    - name: Get JSON output from sensors
      command: sensors -j
      register: sensors_raw
      changed_when: false

    - name: Parse JSON output
      set_fact:
        sensors_json: "{{ sensors_raw.stdout | from_json }}"

    - name: Extract core temperatures
      set_fact:
        cores: >-
          {{
            sensors_json[sensor_group]
            | dict2items
            | selectattr("key", "match", "^Core [0-9]+$")
            | map(attribute="value")
            | list
          }}

    - name: Build temperature summary
      set_fact:
        temp_summary: >-
          {{
            cores | zip(range(cores | length))
            | map(lambda c: "Core " ~ c[1] ~ ": " ~ c[0]['temp' ~ (c[1]+2) ~ '_input'] ~ "Â°C")
            | join(', ')
          }}

    - name: Check for hot cores
      set_fact:
        hot_core_found: >-
          {{
            cores
            | map(attribute='temp2_input', default=0.0)
            | select(">", threshold)
            | list
            | length > 0
          }}

    - name: Send Discord alert if any core is too hot
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body: >
          {
            "content": "ðŸ”¥ {{ inventory_hostname }}: CPU temperature alert!\n{{ temp_summary }}\nThreshold: {{ threshold }}Â°C"
          }
        headers:
          Content-Type: application/json
        status_code: 204
      when: hot_core_found

